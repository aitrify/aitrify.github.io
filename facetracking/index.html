<div>  
    <video id="img" autoplay="true" style="display: none"></video>
    <canvas></canvas>
</div>  

<p><script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/posenet"></script></p>

<script type="text/javascript"  >


var imageScaleFactor = 0.2;  
var outputStride = 16;  
var flipHorizontal = false;

var imageElement = document.getElementById("img");  
imageElement.width = 400;  
imageElement.height = 400;

const video = imageElement;  
const canvas = document.querySelector("canvas");  
canvas.style="display:block; margin: 0 auto;";
canvas.width = imageElement.width;  
canvas.height = imageElement.height;

const ctx = canvas.getContext("2d");

navigator.mediaDevices  
  .getUserMedia({
    audio: false,
    video: {
      height: imageElement.height,
      width: imageElement.width,
      facingMode: "user"
    }
  })
  .then(function(stream) {
    video.srcObject = stream;
  })
  .catch(function(err0r) {
    console.log(err0r.message);
    console.log("Something went wrong!");
  });

const parts = {  
  nose: {},
  leye: {},
  reye: {},
  lear: {},
  rear: {}
};
var count = 0  
video.addEventListener("play", () => {  
  posenet
    .load()
    .then(function(net) {
      console.log("Model loaded");
      const v = document.querySelector("video");
      setInterval(() => {

        net
          .estimateSinglePose(v, imageScaleFactor, flipHorizontal, outputStride)
          .then(function(pose) {
            ctx.fillStyle = "red";

            pose.keypoints.forEach(k => {
             if (/nose/.test(k.part) && k.score > 0.8) parts.nose = k;
             if (/leftEye/.test(k.part) && k.score > 0.8) parts.leye = k;
             if (/rightEye/.test(k.part) && k.score > 0.8) parts.reye = k;
            });

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            ctx.drawImage(imageElement, 0, 0);
            count++
            if(count==20){
               var pngUrl = canvas.toDataURL();
fetch('/testimg', {  
mode: 'cors',  
method: 'POST',  
 headers: {
            "Content-Type": "application/json",
            // "Content-Type": "application/x-www-form-urlencoded",
        },
body: JSON.stringify({img: pngUrl})  
})
            }

            Object.keys(parts).forEach(k => {
              const part = parts[k];
              if (!part.position) return;
              const size = 10;
              ctx.fillRect(
                part.position.x - size / 2,
                part.position.y - size / 2,
                size,
                size
              );
            });

          });
      }, 100);
    })

    .catch(err => {
      console.log(err.message);
    });
});

</script>
